name: GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          
      - name: Show Go version
        run: |
          echo "ğŸ“Œ Goãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª"
          go version
          echo "GOROOT: $(go env GOROOT)"
          echo "GOPATH: $(go env GOPATH)"

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
          go mod download
          go mod verify
          echo "âœ… ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"

      - name: Create docs directory
        run: |
          echo "ğŸ“ docsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ"
          mkdir -p docs
          ls -la

      - name: Build WebAssembly
        run: |
          echo "ğŸ”¨ WebAssemblyãƒ“ãƒ«ãƒ‰ã‚’é–‹å§‹"
          export GOOS=js
          export GOARCH=wasm
          
          # ãƒ“ãƒ«ãƒ‰å‰ã«ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã‚’ç¢ºèª
          if [ ! -f "miko_game_with_worshippers.go" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: miko_game_with_worshippers.go ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            ls -la *.go
            exit 1
          fi
          
          echo "ğŸ“Š ãƒ“ãƒ«ãƒ‰å¯¾è±¡: miko_game_with_worshippers.go"
          
          # ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
          go build -ldflags="-s -w" -o docs/game.wasm miko_game_with_worshippers.go
          
          # ãƒ“ãƒ«ãƒ‰çµæœç¢ºèª
          if [ ! -f "docs/game.wasm" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: game.wasmã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi
          
          echo "âœ… WebAssemblyãƒ“ãƒ«ãƒ‰å®Œäº†"
          echo "ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(ls -lh docs/game.wasm | awk '{print $5}')"

      - name: Copy Go WASM runtime
        run: |
          echo "ğŸ“‹ wasm_exec.jsã‚’ã‚³ãƒ”ãƒ¼"
          
          # Goç’°å¢ƒã®wasm_exec.jsã‚’æ¤œç´¢
          WASM_EXEC_PATH="$(go env GOROOT)/misc/wasm/wasm_exec.js"
          
          # æ–°ã—ã„ãƒ‘ã‚¹ã‚‚è©¦ã™
          if [ ! -f "$WASM_EXEC_PATH" ]; then
            WASM_EXEC_PATH="$(go env GOROOT)/lib/wasm/wasm_exec.js"
          fi
          
          if [ ! -f "$WASM_EXEC_PATH" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: wasm_exec.jsãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "æ¤œç´¢ãƒ‘ã‚¹è©¦è¡Œ: "
            echo "  - $(go env GOROOT)/misc/wasm/wasm_exec.js"
            echo "  - $(go env GOROOT)/lib/wasm/wasm_exec.js"
            # ä»£æ›¿ãƒ‘ã‚¹ã‚’è©¦ã™
            echo "æ¤œç´¢ä¸­..."
            find $(go env GOROOT) -name "wasm_exec.js" -type f 2>/dev/null || true
            exit 1
          fi
          
          cp "$WASM_EXEC_PATH" docs/
          
          if [ ! -f "docs/wasm_exec.js" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: wasm_exec.jsã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi
          
          echo "âœ… wasm_exec.jsã‚³ãƒ”ãƒ¼å®Œäº†"
          echo "ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(ls -lh docs/wasm_exec.js | awk '{print $5}')"

      - name: Copy HTML and assets
        run: |
          echo "ğŸ“„ HTMLãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‚¢ã‚»ãƒƒãƒˆã‚’ã‚³ãƒ”ãƒ¼"
          
          # index.htmlãŒå­˜åœ¨ã—ãªã„å ´åˆã¯åŸºæœ¬çš„ãªã‚‚ã®ã‚’ä½œæˆ
          if [ ! -f "docs/index.html" ]; then
            echo "âš ï¸ index.htmlãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚åŸºæœ¬çš„ãªHTMLã‚’ä½œæˆã—ã¾ã™ã€‚"
            cat > docs/index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>æ±Ÿæˆ¸å‰ã‚¨ãƒ«ãƒ•</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #222;
        }
        #loading {
            color: white;
            font-family: sans-serif;
            font-size: 1.5em;
        }
        canvas {
            border: 1px solid #444;
        }
    </style>
</head>
<body>
    <div id="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
    <script src="wasm_exec.js"></script>
    <script>
        if (!WebAssembly.instantiateStreaming) {
            WebAssembly.instantiateStreaming = async (resp, importObject) => {
                const source = await (await resp).arrayBuffer();
                return await WebAssembly.instantiate(source, importObject);
            };
        }
        
        const go = new Go();
        WebAssembly.instantiateStreaming(fetch("game.wasm"), go.importObject).then((result) => {
            go.run(result.instance);
            document.getElementById('loading').style.display = 'none';
        }).catch((err) => {
            console.error(err);
            document.getElementById('loading').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + err.message;
        });
    </script>
</body>
</html>
EOF
          else
            echo "âœ… æ—¢å­˜ã®index.htmlã‚’ä½¿ç”¨"
          fi
          
          # ã‚¢ã‚»ãƒƒãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚³ãƒ”ãƒ¼
          if [ -d "assets" ]; then
            cp -r assets docs/
            echo "âœ… assetsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚³ãƒ”ãƒ¼"
          else
            echo "âš ï¸ assetsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          fi
          
          # ãã®ä»–ã®å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
          [ -f "_config.yml" ] && cp _config.yml docs/
          [ -f "_headers" ] && cp _headers docs/

      - name: Create .nojekyll
        run: |
          touch docs/.nojekyll
          echo "âœ… .nojekyllãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ"

      - name: List build artifacts
        run: |
          echo "ğŸ“¦ ãƒ“ãƒ«ãƒ‰æˆæœç‰©:"
          ls -la docs/
          echo ""
          echo "ğŸ“Š ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡:"
          du -sh docs/*

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs

  deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4